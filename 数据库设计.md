# Sara二手售卖网站 - 数据库设计文档

## 数据库概述

**数据库类型：** SQLite  
**ORM框架：** SQLAlchemy  
**数据库文件：** `sara_shop.db`  
**字符编码：** UTF-8  

## 数据表设计

### 1. 产品表 (products)

用于存储所有二手商品信息

```sql
CREATE TABLE products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    category VARCHAR(50) NOT NULL,
    condition VARCHAR(20) NOT NULL,
    stock_status VARCHAR(20) DEFAULT 'available',
    face_to_face_only BOOLEAN DEFAULT FALSE NOT NULL,  -- 是否仅支持见面交易
    images TEXT,  -- JSON格式存储多张图片URL
    specifications TEXT,  -- JSON格式存储商品规格
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 字段说明
- `id`: 商品唯一标识符
- `name`: 商品名称（如：9成新笔记本电脑）
- `description`: 商品详细描述
- `price`: 商品价格（新西兰元）
- `category`: 商品分类（electronics, clothing, anime, appliances, other）
- `condition`: 商品成色（9成新、8.5成新等）
- `stock_status`: 库存状态（available, sold, reserved）
- `face_to_face_only`: 是否仅支持见面交易（贵重物品如电脑、手机等建议设为True）
- `images`: 图片链接数组，JSON格式
- `specifications`: 商品规格，JSON格式（尺寸、颜色、品牌等）
- `created_at`: 创建时间
- `updated_at`: 更新时间

#### 示例数据
```json
{
    "id": 1,
    "name": "9成新笔记本电脑",
    "description": "多角度实拍，性能优良，适合办公学习。使用时间短，保养良好。",
    "price": 650.00,
    "category": "electronics",
    "condition": "9成新",
    "stock_status": "available",
    "face_to_face_only": true,
    "images": [
        "https://images.unsplash.com/photo-1517336714731-489689fd1ca8",
        "https://images.unsplash.com/photo-1541807084-5c52b6b3adef"
    ],
    "specifications": {
        "brand": "Dell",
        "model": "Inspiron 15",
        "cpu": "Intel i5",
        "ram": "8GB",
        "storage": "256GB SSD"
    }
}
```

### 2. 订单表 (orders)

用于存储客户订单信息

```sql
CREATE TABLE orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    customer_name VARCHAR(100) NOT NULL,
    customer_contact VARCHAR(50) NOT NULL,
    customer_email VARCHAR(100),
    items TEXT NOT NULL,  -- JSON格式存储订单商品
    total_amount DECIMAL(10,2) NOT NULL,
    delivery_method VARCHAR(20) NOT NULL,
    payment_method VARCHAR(30) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    shipping_address TEXT,
    pickup_location VARCHAR(200),
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 字段说明
- `id`: 订单唯一标识符
- `order_number`: 订单号（格式：SR20250624001）
- `customer_name`: 客户姓名
- `customer_contact`: 客户联系方式（电话）
- `customer_email`: 客户邮箱
- `items`: 订单商品信息，JSON格式
- `total_amount`: 订单总金额
- `delivery_method`: 交付方式（pickup, shipping）
- `payment_method`: 支付方式（anz_transfer, other_bank, cash, wechat, alipay）
- `status`: 订单状态（pending, paid, shipped, completed, cancelled）
- `shipping_address`: 邮寄地址
- `pickup_location`: 面交地点
- `notes`: 订单备注
- `created_at`: 订单创建时间
- `updated_at`: 订单更新时间

#### 订单状态流转
```
pending(待支付) → paid(已支付) → shipped(已发货) → completed(已完成)
                ↓
            cancelled(已取消)
```

#### 示例数据
```json
{
    "id": 1,
    "order_number": "SR20250624001",
    "customer_name": "张三",
    "customer_contact": "021234567",
    "customer_email": "zhang@example.com",
    "items": [
        {
            "product_id": 1,
            "name": "9成新笔记本电脑",
            "price": 650.00,
            "quantity": 1
        }
    ],
    "total_amount": 665.00,
    "delivery_method": "shipping",
    "payment_method": "anz_transfer",
    "status": "pending",
    "shipping_address": "123 Queen Street, Auckland",
    "notes": "请在工作日发货"
}
```

### 3. 留言表 (messages)

用于存储客户留言和咨询

```sql
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    contact VARCHAR(100) NOT NULL,
    message TEXT NOT NULL,
    status VARCHAR(20) DEFAULT 'unread',
    reply TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    replied_at DATETIME
);
```

#### 字段说明
- `id`: 留言唯一标识符
- `name`: 留言者姓名
- `contact`: 留言者联系方式
- `message`: 留言内容
- `status`: 处理状态（unread, replied, archived）
- `reply`: 回复内容
- `created_at`: 留言时间
- `replied_at`: 回复时间

#### 示例数据
```json
{
    "id": 1,
    "name": "李四",
    "contact": "li@example.com",
    "message": "您好，请问笔记本电脑还有货吗？可以看实物再决定购买吗？",
    "status": "replied",
    "reply": "您好！笔记本电脑还有货，欢迎面交查看实物。请联系我安排见面时间。",
    "created_at": "2025-06-24 10:30:00",
    "replied_at": "2025-06-24 11:15:00"
}
```

## SQLAlchemy模型设计

### 产品模型 (Product)
```python
from flask_sqlalchemy import SQLAlchemy
import json
from datetime import datetime

db = SQLAlchemy()

class Product(db.Model):
    __tablename__ = 'products'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text)
    price = db.Column(db.Numeric(10, 2), nullable=False)
    category = db.Column(db.String(50), nullable=False)
    condition = db.Column(db.String(20), nullable=False)
    stock_status = db.Column(db.String(20), default='available')
    face_to_face_only = db.Column(db.Boolean, default=False, nullable=False)  # 是否仅支持见面交易
    images = db.Column(db.Text)  # JSON string
    specifications = db.Column(db.Text)  # JSON string
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def get_images(self):
        """获取图片列表"""
        if self.images:
            return json.loads(self.images)
        return []
    
    def set_images(self, image_list):
        """设置图片列表"""
        self.images = json.dumps(image_list)
    
    def get_specifications(self):
        """获取规格信息"""
        if self.specifications:
            return json.loads(self.specifications)
        return {}
    
    def set_specifications(self, spec_dict):
        """设置规格信息"""
        self.specifications = json.dumps(spec_dict)
    
    def to_dict(self):
        """转换为字典格式"""
        return {
            'id': self.id,
            'name': self.name,
            'description': self.description,
            'price': float(self.price),
            'category': self.category,
            'condition': self.condition,
            'stock_status': self.stock_status,
            'face_to_face_only': self.face_to_face_only,
            'images': self.get_images(),
            'specifications': self.get_specifications(),
            'created_at': self.created_at.isoformat(),
            'updated_at': self.updated_at.isoformat()
        }
```

### 订单模型 (Order)
```python
import uuid

class Order(db.Model):
    __tablename__ = 'orders'
    
    id = db.Column(db.Integer, primary_key=True)
    order_number = db.Column(db.String(50), unique=True, nullable=False)
    customer_name = db.Column(db.String(100), nullable=False)
    customer_contact = db.Column(db.String(50), nullable=False)
    customer_email = db.Column(db.String(100))
    items = db.Column(db.Text, nullable=False)  # JSON string
    total_amount = db.Column(db.Numeric(10, 2), nullable=False)
    delivery_method = db.Column(db.String(20), nullable=False)
    payment_method = db.Column(db.String(30), nullable=False)
    status = db.Column(db.String(20), default='pending')
    shipping_address = db.Column(db.Text)
    pickup_location = db.Column(db.String(200))
    notes = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        if not self.order_number:
            self.order_number = self.generate_order_number()
    
    def generate_order_number(self):
        """生成订单号"""
        from datetime import datetime
        now = datetime.now()
        return f"SR{now.strftime('%Y%m%d')}{str(uuid.uuid4())[:6].upper()}"
    
    def get_items(self):
        """获取订单商品列表"""
        if self.items:
            return json.loads(self.items)
        return []
    
    def set_items(self, items_list):
        """设置订单商品列表"""
        self.items = json.dumps(items_list)
    
    def to_dict(self):
        """转换为字典格式"""
        return {
            'id': self.id,
            'order_number': self.order_number,
            'customer_name': self.customer_name,
            'customer_contact': self.customer_contact,
            'customer_email': self.customer_email,
            'items': self.get_items(),
            'total_amount': float(self.total_amount),
            'delivery_method': self.delivery_method,
            'payment_method': self.payment_method,
            'status': self.status,
            'shipping_address': self.shipping_address,
            'pickup_location': self.pickup_location,
            'notes': self.notes,
            'created_at': self.created_at.isoformat(),
            'updated_at': self.updated_at.isoformat()
        }
```

### 留言模型 (Message)
```python
class Message(db.Model):
    __tablename__ = 'messages'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    contact = db.Column(db.String(100), nullable=False)
    message = db.Column(db.Text, nullable=False)
    status = db.Column(db.String(20), default='unread')
    reply = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    replied_at = db.Column(db.DateTime)
    
    def to_dict(self):
        """转换为字典格式"""
        return {
            'id': self.id,
            'name': self.name,
            'contact': self.contact,
            'message': self.message,
            'status': self.status,
            'reply': self.reply,
            'created_at': self.created_at.isoformat(),
            'replied_at': self.replied_at.isoformat() if self.replied_at else None
        }
```

## 数据库初始化

### 初始化脚本 (init_db.py)
```python
from flask import Flask
from models import db, Product, Order, Message
import json

def create_app():
    app = Flask(__name__)
    app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///sara_shop.db'
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    db.init_app(app)
    return app

def init_database():
    """初始化数据库"""
    app = create_app()
    with app.app_context():
        # 创建所有表
        db.create_all()
        
        # 添加示例产品数据
        sample_products = [
            {
                'name': '9成新笔记本电脑',
                'description': '多角度实拍，性能优良，适合办公学习。Dell Inspiron 15，Intel i5处理器，8GB内存，256GB SSD。',
                'price': 650.00,
                'category': 'electronics',
                'condition': '9成新',
                'images': [
                    'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=400&q=80'
                ],
                'specifications': {
                    'brand': 'Dell',
                    'model': 'Inspiron 15',
                    'cpu': 'Intel i5',
                    'ram': '8GB',
                    'storage': '256GB SSD'
                }
            },
            {
                'name': '8.5成新保暖大衣',
                'description': '冬季必备，时尚保暖，尺码齐全。高质量面料，保养良好。',
                'price': 80.00,
                'category': 'clothing',
                'condition': '8.5成新',
                'images': [
                    'https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=400&q=80'
                ],
                'specifications': {
                    'size': 'M',
                    'color': '黑色',
                    'material': '羽绒'
                }
            }
            # 可添加更多示例产品...
        ]
        
        for product_data in sample_products:
            product = Product(
                name=product_data['name'],
                description=product_data['description'],
                price=product_data['price'],
                category=product_data['category'],
                condition=product_data['condition']
            )
            product.set_images(product_data['images'])
            product.set_specifications(product_data['specifications'])
            db.session.add(product)
        
        db.session.commit()
        print("数据库初始化完成！")

if __name__ == '__main__':
    init_database()
```

## 索引设计

为提高查询性能，建议创建以下索引：

```sql
-- 产品表索引
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_stock_status ON products(stock_status);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_face_to_face_only ON products(face_to_face_only);

-- 订单表索引
CREATE INDEX idx_orders_order_number ON orders(order_number);
CREATE INDEX idx_orders_customer_email ON orders(customer_email);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);

-- 留言表索引
CREATE INDEX idx_messages_status ON messages(status);
CREATE INDEX idx_messages_created_at ON messages(created_at);
```

## 数据备份策略

1. **日常备份：** 每日自动备份SQLite文件
2. **版本控制：** 保留最近7天的备份文件
3. **备份验证：** 定期验证备份文件完整性

---

**文档版本：** 1.1  
**创建时间：** 2025-06-24  
**最后更新：** 2025-06-25  
**更新内容：** 添加 face_to_face_only 字段支持仅见面交易功能  
**审核状态：** 待审核