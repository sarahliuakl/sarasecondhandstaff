{% extends "base.html" %}
{% block title %}è´­ç‰©è½¦ - Saraçš„äºŒæ‰‹å”®å–{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto">
  <h2 class="text-3xl font-bold text-orange-700 mb-6">æˆ‘çš„è´­ç‰©è½¦</h2>
  
  <!-- è´­ç‰©è½¦å†…å®¹å®¹å™¨ -->
  <div id="cartContainer">
    <!-- ç©ºè´­ç‰©è½¦æç¤º -->
    <div id="emptyCart" class="text-center py-12 hidden">
      <svg class="w-24 h-24 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 4M7 13l2.5 4m6 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
      </svg>
      <h3 class="text-xl font-medium text-gray-700 mb-2">è´­ç‰©è½¦æ˜¯ç©ºçš„</h3>
      <p class="text-gray-500 mb-4">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å•†å“åˆ°è´­ç‰©è½¦</p>
      <a href="{{ url_for('main.products') }}" class="inline-block bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600 transition">
        å»è´­ç‰©
      </a>
    </div>

    <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
    <div id="cartItems" class="space-y-4 hidden">
      <!-- å•†å“é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
    </div>

    <!-- è´­ç‰©è½¦æ€»è®¡ -->
    <div id="cartSummary" class="hidden bg-gray-50 rounded-lg p-6 mt-6">
      <div class="flex justify-between items-center mb-4">
        <span class="text-lg font-medium">å•†å“å°è®¡:</span>
        <span id="subtotal" class="text-xl font-bold text-orange-600">NZD $0.00</span>
      </div>
      
      <div class="flex justify-between items-center mb-4" id="shippingFeeRow">
        <span class="text-lg font-medium">é¢„ä¼°é‚®è´¹:</span>
        <span id="shippingFee" class="text-lg text-gray-600">NZD $15.00</span>
      </div>
      
      <div id="faceToFaceOnlyWarning" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4">
        <div class="flex items-center text-purple-700">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          è´­ç‰©è½¦ä¸­åŒ…å«ä»…è§é¢äº¤æ˜“å•†å“ï¼Œåªèƒ½é€‰æ‹©å½“é¢äº¤æ˜“
        </div>
      </div>
      
      <hr class="my-4">
      
      <div class="flex justify-between items-center mb-6">
        <span class="text-xl font-bold">æ€»è®¡:</span>
        <span id="total" class="text-2xl font-bold text-orange-600">NZD $0.00</span>
      </div>
      
      <div class="space-y-3">
        <button onclick="proceedToCheckout()" 
                class="w-full bg-orange-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-orange-600 transition">
          è®¢å•ç¡®è®¤
        </button>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <a href="{{ url_for('main.products') }}" 
             class="block text-center bg-gray-100 text-gray-700 py-2 px-4 rounded font-medium hover:bg-gray-200 transition">
            ç»§ç»­è´­ç‰©
          </a>
          <button onclick="clearCart()" 
                  class="bg-red-100 text-red-700 py-2 px-4 rounded font-medium hover:bg-red-200 transition">
            æ¸…ç©ºè´­ç‰©è½¦
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- äº¤ä»˜å’Œæ”¯ä»˜è¯´æ˜ -->
  <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- äº¤ä»˜æ–¹å¼ -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-blue-800 mb-4">äº¤ä»˜æ–¹å¼</h3>
      <div class="space-y-3">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-blue-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          </svg>
          <div>
            <div class="font-medium text-blue-800">å½“é¢äº¤æ˜“</div>
            <div class="text-sm text-blue-600">å¥¥å…‹å…°åœ°åŒºæ¨èï¼Œå…é‚®è´¹</div>
          </div>
        </div>
        
        <div class="flex items-start">
          <svg class="w-5 h-5 text-blue-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
          </svg>
          <div>
            <div class="font-medium text-blue-800">é‚®å¯„</div>
            <div class="text-sm text-blue-600">æ–°è¥¿å…°å…¨å›½ï¼Œé‚®è´¹çº¦ NZD $15</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ”¯ä»˜æ–¹å¼ -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-green-800 mb-4">æ”¯ä»˜æ–¹å¼</h3>
      <div class="space-y-2 text-sm">
        <div class="flex items-center text-green-700">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          ANZé“¶è¡Œè½¬è´¦ï¼ˆæ¨èï¼‰
        </div>
        <div class="flex items-center text-green-700">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          è·¨è¡Œè½¬è´¦
        </div>
        <div class="flex items-center text-green-700">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          ç°é‡‘/å¾®ä¿¡/æ”¯ä»˜å®ï¼ˆå½“é¢ï¼‰
        </div>
      </div>
    </div>
  </div>

  <!-- è´­ä¹°é¡»çŸ¥ -->
  <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
    <h3 class="text-lg font-semibold text-yellow-800 mb-3">è´­ä¹°é¡»çŸ¥</h3>
    <ul class="text-sm text-yellow-700 space-y-1">
      <li>â€¢ äºŒæ‰‹ç‰©å“ç»å½“é¢ç¡®è®¤åä¸æ”¯æŒé€€è´§</li>
      <li>â€¢ æ‰€æœ‰å’¨è¯¢æˆ‘ä¼šåœ¨2å°æ—¶å†…å›å¤</li>
      <li>â€¢ å½“é¢äº¤æ˜“åœ°ç‚¹ä¼šé€šè¿‡çŸ­ä¿¡ç¡®è®¤ï¼Œä¿æŠ¤åŒæ–¹éšç§</li>
      <li>â€¢ è·¨è¡Œè½¬è´¦è¯·æå‰è”ç³»ç¡®è®¤åˆ°è´¦æ—¶é—´</li>
      <li>â€¢ å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»ï¼š0225255862</li>
    </ul>
  </div>
</div>

<!-- JavaScript -->
<script>
// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹
document.addEventListener('DOMContentLoaded', function() {
  displayCart();
  updateCartCount();
});

// æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹
function displayCart() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const emptyCart = document.getElementById('emptyCart');
  const cartItems = document.getElementById('cartItems');
  const cartSummary = document.getElementById('cartSummary');
  
  if (cart.length === 0) {
    emptyCart.classList.remove('hidden');
    cartItems.classList.add('hidden');
    cartSummary.classList.add('hidden');
  } else {
    emptyCart.classList.add('hidden');
    cartItems.classList.remove('hidden');
    cartSummary.classList.remove('hidden');
    
    // æ¸…ç©ºç°æœ‰å†…å®¹
    cartItems.innerHTML = '';
    
    // æ·»åŠ å•†å“é¡¹
    cart.forEach((item, index) => {
      const itemElement = createCartItemElement(item, index);
      cartItems.appendChild(itemElement);
    });
    
    // æ›´æ–°æ€»è®¡
    updateCartSummary();
  }
}

// åˆ›å»ºè´­ç‰©è½¦å•†å“å…ƒç´ 
function createCartItemElement(item, index) {
  const div = document.createElement('div');
  div.className = 'bg-white rounded-lg border border-gray-200 p-4 flex flex-col sm:flex-row gap-4';
  
  div.innerHTML = `
    <div class="flex-shrink-0">
      <img src="${item.image || 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=400&q=80'}" 
           alt="${item.name}" 
           class="w-24 h-24 object-cover rounded">
    </div>
    
    <div class="flex-1">
      <h4 class="font-semibold text-lg mb-1">${item.name}</h4>
      <p class="text-sm text-gray-600 mb-2">æˆè‰²ï¼š${item.condition}</p>
      ${item.face_to_face_only ? '<p class="text-xs text-purple-600 mb-2">ğŸ”’ ä»…è§é¢äº¤æ˜“</p>' : ''}
      <p class="text-lg font-bold text-orange-600">NZD $${item.price.toFixed(2)}</p>
    </div>
    
    <div class="flex items-center justify-between sm:flex-col sm:justify-center gap-4">
      <div class="flex items-center border border-gray-300 rounded">
        <button onclick="updateQuantity(${index}, ${item.quantity - 1})" 
                class="px-3 py-1 hover:bg-gray-100 transition ${item.quantity <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
          -
        </button>
        <span class="px-4 py-1 border-l border-r border-gray-300">${item.quantity}</span>
        <button onclick="updateQuantity(${index}, ${item.quantity + 1})" 
                class="px-3 py-1 hover:bg-gray-100 transition">
          +
        </button>
      </div>
      
      <button onclick="removeFromCart(${index})" 
              class="text-red-600 hover:text-red-700 text-sm transition">
        åˆ é™¤
      </button>
    </div>
  `;
  
  return div;
}

// æ›´æ–°å•†å“æ•°é‡
function updateQuantity(index, newQuantity) {
  if (newQuantity < 1) return;
  
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (cart[index]) {
    cart[index].quantity = newQuantity;
    localStorage.setItem('cart', JSON.stringify(cart));
    displayCart();
    updateCartCount();
  }
}

// ä»è´­ç‰©è½¦ç§»é™¤å•†å“
function removeFromCart(index) {
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  cart.splice(index, 1);
  localStorage.setItem('cart', JSON.stringify(cart));
  displayCart();
  updateCartCount();
  showMessage('å•†å“å·²ä»è´­ç‰©è½¦ç§»é™¤', 'info');
}

// æ¸…ç©ºè´­ç‰©è½¦
function clearCart() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) {
    localStorage.removeItem('cart');
    displayCart();
    updateCartCount();
    showMessage('è´­ç‰©è½¦å·²æ¸…ç©º', 'info');
  }
}

// æ›´æ–°è´­ç‰©è½¦æ€»è®¡
function updateCartSummary() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  let subtotal = 0;
  let hasFaceToFaceOnlyItems = false;
  
  cart.forEach(item => {
    subtotal += item.price * item.quantity;
    if (item.face_to_face_only) {
      hasFaceToFaceOnlyItems = true;
    }
  });
  
  const shippingFeeRow = document.getElementById('shippingFeeRow');
  const faceToFaceWarning = document.getElementById('faceToFaceOnlyWarning');
  const shippingFeeElement = document.getElementById('shippingFee');
  
  let shippingFee = 0;
  let total = subtotal;
  
  if (hasFaceToFaceOnlyItems) {
    // å¦‚æœæœ‰ä»…è§é¢äº¤æ˜“å•†å“ï¼Œéšè—é‚®è´¹æ˜¾ç¤ºè­¦å‘Š
    shippingFeeRow.style.display = 'none';
    faceToFaceWarning.classList.remove('hidden');
    shippingFee = 0;
  } else {
    // æ™®é€šå•†å“ï¼Œæ˜¾ç¤ºé‚®è´¹
    shippingFeeRow.style.display = 'flex';
    faceToFaceWarning.classList.add('hidden');
    shippingFee = 15.00;
    total = subtotal + shippingFee;
    shippingFeeElement.textContent = `NZD $${shippingFee.toFixed(2)}`;
  }
  
  document.getElementById('subtotal').textContent = `NZD $${subtotal.toFixed(2)}`;
  document.getElementById('total').textContent = `NZD $${total.toFixed(2)}`;
}

// å‰å¾€è®¢å•ç¡®è®¤
function proceedToCheckout() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (cart.length === 0) {
    showMessage('è´­ç‰©è½¦æ˜¯ç©ºçš„', 'error');
    return;
  }
  
  // è·³è½¬åˆ°è®¢å•ç¡®è®¤é¡µé¢
  window.location.href = '/order/confirm';
}

// æ›´æ–°è´­ç‰©è½¦è®¡æ•°
function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  
  const cartCountElements = document.querySelectorAll('.cart-count');
  cartCountElements.forEach(element => {
    element.textContent = totalItems;
    element.style.display = totalItems > 0 ? 'inline' : 'none';
  });
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type = 'info') {
  const messageDiv = document.createElement('div');
  messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
    type === 'success' ? 'bg-green-500 text-white' : 
    type === 'error' ? 'bg-red-500 text-white' : 
    'bg-blue-500 text-white'
  }`;
  messageDiv.textContent = message;
  
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    document.body.removeChild(messageDiv);
  }, 3000);
}
</script>

{% endblock %}