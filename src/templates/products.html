{% extends "base.html" %}
{% block title %}{% if current_category %}{{ dict(categories)[current_category] }}{% elif search_term %}æœç´¢"{{ search_term }}"çš„ç»“æœ{% else %}å…¨éƒ¨å•†å“{% endif %} - Saraçš„äºŒæ‰‹å”®å–{% endblock %}

{% block description %}{% if current_category %}{{ dict(categories)[current_category] }}åˆ†ç±»ä¸‹çš„{% elif search_term %}æœç´¢"{{ search_term }}"çš„{% else %}å…¨éƒ¨{% endif %}äºŒæ‰‹å•†å“ï¼Œæ–°è¥¿å…°å¥¥å…‹å…°åœ°åŒºä¼˜è´¨äºŒæ‰‹å•†å“ï¼Œå“è´¨ä¿è¯ï¼Œä»·æ ¼ä¼˜æƒ {% endblock %}

{% block keywords %}{% if current_category %}{{ dict(categories)[current_category] }},{% endif %}{% if search_term %}{{ search_term }},{% endif %}äºŒæ‰‹å•†å“,å•†å“åˆ—è¡¨,æ–°è¥¿å…°,å¥¥å…‹å…°,Sara{% endblock %}

{% block structured_data %}
{{ super() }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "{% if current_category %}{{ dict(categories)[current_category] }}{% elif search_term %}æœç´¢ç»“æœ{% else %}å…¨éƒ¨å•†å“{% endif %}",
  "numberOfItems": {{ products|length }},
  "itemListElement": [
    {% for product in products[:10] %}
    {
      "@type": "ListItem",
      "position": {{ loop.index }},
      "item": {
        "@type": "Product",
        "name": "{{ product.name }}",
        "description": "{{ product.description[:100]|replace('"', '\\"') }}",
        "offers": {
          "@type": "Offer",
          "priceCurrency": "NZD",
          "price": "{{ product.price }}",
          "availability": "{% if product.is_available() %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}"
        }
      }
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="hero-section text-center mb-12">
  <h2 class="section-title mb-4">ğŸ›ï¸ ç²¾é€‰äºŒæ‰‹å•†å“</h2>
  <p class="section-subtitle max-w-2xl mx-auto">
    å‘ç°æ›´å¤šä¼˜è´¨å¥½ç‰©ï¼Œæ¯ä¸€ä»¶éƒ½æœ‰ç‹¬ç‰¹çš„æ•…äº‹ç­‰å¾…ä¸æ‚¨ç›¸é‡
  </p>
</div>

<!-- Search and Filter Section -->
<div class="card p-8 mb-8">
  <form method="GET" id="searchForm" class="space-y-6">
    <!-- Main Search Bar -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
      <div class="flex gap-3 relative flex-1 max-w-2xl">
        <div class="relative flex-1">
          <input type="text" name="search" id="searchInput" value="{{ search_term or '' }}" 
                 placeholder="æœç´¢å•†å“åç§°ã€æè¿°ã€åˆ†ç±»..." 
                 class="w-full px-4 py-3 border-2 border-pink-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-pink-300 bg-white/50 backdrop-blur-sm"
                 autocomplete="off">
          
          <!-- æœç´¢å»ºè®®ä¸‹æ‹‰æ¡† -->
          <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white/95 backdrop-blur-md border border-pink-200 rounded-xl shadow-xl z-10 hidden max-h-60 overflow-y-auto mt-2">
            <!-- æœç´¢å»ºè®®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
          </div>
        </div>
        
        <button type="submit" class="btn-primary px-6 py-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          æœç´¢
        </button>
        
        <button type="button" id="toggleFilters" class="bg-white/70 text-gray-700 px-4 py-3 rounded-xl hover:bg-white/90 transition border-2 border-gray-200 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
          </svg>
          ç­›é€‰
        </button>
      </div>
      
      <div class="text-right">
        <p class="text-gray-600 text-sm">å…±æ‰¾åˆ°</p>
        <p class="text-2xl font-bold bg-gradient-to-r from-pink-500 to-red-500 bg-clip-text text-transparent">{{ products|length }}</p>
        <p class="text-gray-600 text-sm">ä¸ªå•†å“</p>
      </div>
    </div>

    <!-- Advanced Filters (Initially Hidden) -->
    <div id="advancedFilters" class="hidden grid md:grid-cols-2 lg:grid-cols-4 gap-4 p-6 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-gray-200">
      <!-- Category Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">å•†å“åˆ†ç±»</label>
        <select name="category" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-pink-300 bg-white/70">
          <option value="">æ‰€æœ‰åˆ†ç±»</option>
          {% for category_code, category_name in categories %}
          <option value="{{ category_code }}" {{ 'selected' if current_category == category_code else '' }}>{{ category_name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Condition Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">å•†å“æˆè‰²</label>
        <select name="condition" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-pink-300 bg-white/70">
          <option value="">æ‰€æœ‰æˆè‰²</option>
          {% for condition in conditions %}
          <option value="{{ condition }}" {{ 'selected' if current_condition == condition else '' }}>{{ condition }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Price Range -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ä»·æ ¼èŒƒå›´ (NZD)</label>
        <div class="flex gap-2">
          <input type="number" name="min_price" value="{{ current_min_price or '' }}" placeholder="æœ€ä½" 
                 class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-pink-300 bg-white/70" step="0.01">
          <input type="number" name="max_price" value="{{ current_max_price or '' }}" placeholder="æœ€é«˜" 
                 class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-pink-300 bg-white/70" step="0.01">
        </div>
      </div>

      <!-- Sort Options -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">æ’åºæ–¹å¼</label>
        <select name="sort" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-pink-300 bg-white/70">
          <option value="newest" {{ 'selected' if current_sort == 'newest' else '' }}>æœ€æ–°ä¸Šæ¶</option>
          <option value="oldest" {{ 'selected' if current_sort == 'oldest' else '' }}>æœ€æ—©ä¸Šæ¶</option>
          <option value="price_asc" {{ 'selected' if current_sort == 'price_asc' else '' }}>ä»·æ ¼ä»ä½åˆ°é«˜</option>
          <option value="price_desc" {{ 'selected' if current_sort == 'price_desc' else '' }}>ä»·æ ¼ä»é«˜åˆ°ä½</option>
          <option value="name" {{ 'selected' if current_sort == 'name' else '' }}>å•†å“åç§°</option>
        </select>
      </div>
    </div>

    <!-- Quick Category Filters -->
    <div class="flex flex-wrap gap-3">
      <a href="{{ url_for('main.products') }}" 
         class="px-6 py-3 rounded-xl font-medium transition {{ 'btn-primary' if not current_category else 'bg-white/70 text-gray-700 hover:bg-white/90 border-2 border-pink-200' }}">
        ğŸ·ï¸ å…¨éƒ¨
      </a>
      {% for category_code, category_name in categories %}
      <a href="{{ url_for('main.products', category=category_code, search=search_term) }}" 
         class="px-6 py-3 rounded-xl font-medium transition {{ 'btn-primary' if current_category == category_code else 'bg-white/70 text-gray-700 hover:bg-white/90 border-2 border-pink-200' }}">
        {{ category_name }}
      </a>
      {% endfor %}
    </div>

    <!-- Active Filters Display -->
    {% if search_term or current_category or current_condition or current_min_price or current_max_price %}
    <div class="flex flex-wrap gap-2 items-center">
      <span class="text-sm font-medium text-gray-700">å½“å‰ç­›é€‰ï¼š</span>
      
      {% if search_term %}
      <div class="bg-gradient-to-r from-blue-100 to-cyan-100 text-blue-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
        <span>æœç´¢: "{{ search_term }}"</span>
        <a href="{{ url_for('main.products', category=current_category, condition=current_condition, min_price=current_min_price, max_price=current_max_price, sort=current_sort) }}" class="text-blue-500 hover:text-blue-700">Ã—</a>
      </div>
      {% endif %}
      
      {% if current_category %}
      <div class="bg-gradient-to-r from-green-100 to-emerald-100 text-green-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
        <span>åˆ†ç±»: {{ dict(categories)[current_category] }}</span>
        <a href="{{ url_for('main.products', search=search_term, condition=current_condition, min_price=current_min_price, max_price=current_max_price, sort=current_sort) }}" class="text-green-500 hover:text-green-700">Ã—</a>
      </div>
      {% endif %}
      
      {% if current_condition %}
      <div class="bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
        <span>æˆè‰²: {{ current_condition }}</span>
        <a href="{{ url_for('main.products', search=search_term, category=current_category, min_price=current_min_price, max_price=current_max_price, sort=current_sort) }}" class="text-purple-500 hover:text-purple-700">Ã—</a>
      </div>
      {% endif %}
      
      {% if current_min_price or current_max_price %}
      <div class="bg-gradient-to-r from-yellow-100 to-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
        <span>ä»·æ ¼: {{ current_min_price or '0' }} - {{ current_max_price or 'âˆ' }} NZD</span>
        <a href="{{ url_for('main.products', search=search_term, category=current_category, condition=current_condition, sort=current_sort) }}" class="text-orange-500 hover:text-orange-700">Ã—</a>
      </div>
      {% endif %}
      
      <a href="{{ url_for('main.products') }}" class="text-sm text-red-600 hover:text-red-700 font-medium">æ¸…é™¤æ‰€æœ‰ç­›é€‰</a>
    </div>
    {% endif %}

    <!-- Search Results Info -->
    {% if search_term or current_category or current_condition or current_min_price or current_max_price %}
    <div class="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
          <span class="text-white text-sm">ğŸ”</span>
        </div>
        <p class="text-blue-700 font-medium">
          {% if search_term %}
            æœç´¢ "{{ search_term }}" çš„ç»“æœï¼Œ
          {% endif %}
          å…±æ‰¾åˆ° {{ products|length }} ä¸ªå•†å“
          {% if current_category %}ï¼Œåˆ†ç±»ï¼š{{ dict(categories)[current_category] }}{% endif %}
          {% if current_condition %}ï¼Œæˆè‰²ï¼š{{ current_condition }}{% endif %}
        </p>
      </div>
    </div>
    {% endif %}
  </form>
</div>

<!-- Products Grid -->
{% if products %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
  {% for product in products %}
  <div class="product-card overflow-hidden">
    <!-- å•†å“å›¾ç‰‡ -->
    {% set images = product.get_images() %}
    <a href="{{ url_for('main.product_detail', product_id=product.id) }}" class="block">
      <div class="product-image relative overflow-hidden h-64 bg-gradient-to-br from-gray-100 to-gray-200">
        <img src="{{ images[0] if images else 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=600&q=80' }}" 
             alt="{{ product.name }}" 
             class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
        <div class="absolute inset-0 bg-black/0 hover:bg-black/10 transition-colors duration-300"></div>
        
        <!-- Status Badge -->
        {% if not product.is_available() %}
        <div class="absolute top-4 left-4 bg-red-500/90 text-white text-xs font-medium px-3 py-1 rounded-full backdrop-blur-sm">
          å·²å”®å‡º
        </div>
        {% else %}
        <div class="absolute top-4 left-4 bg-green-500/90 text-white text-xs font-medium px-3 py-1 rounded-full backdrop-blur-sm">
          åœ¨å”®
        </div>
        {% endif %}
      </div>
    </a>
    
    <div class="p-6">
      <!-- åˆ†ç±»å’Œæˆè‰²æ ‡ç­¾ -->
      <div class="flex flex-wrap gap-2 mb-3">
        <span class="bg-gradient-to-r from-pink-100 to-purple-100 text-pink-700 px-3 py-1 rounded-full text-xs font-medium">
          {{ product.get_category_display() }}
        </span>
        <span class="bg-gradient-to-r from-green-100 to-emerald-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium">
          {{ product.condition }}
        </span>
      </div>
      
      <a href="{{ url_for('main.product_detail', product_id=product.id) }}" class="block group">
        <h4 class="font-semibold text-xl mb-2 text-gray-800 group-hover:text-pink-600 transition-colors">
          {{ product.name }}
        </h4>
      </a>
      
      <p class="text-gray-600 mb-4 leading-relaxed text-sm">
        {{ product.description[:80] + '...' if product.description|length > 80 else product.description }}
      </p>
      
      <div class="flex items-center justify-between mb-4">
        <span class="text-2xl font-bold bg-gradient-to-r from-pink-500 to-red-500 bg-clip-text text-transparent">
          ${{ "%.2f"|format(product.price) }}
        </span>
        <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
          NZD
        </span>
      </div>
      
      <!-- æ“ä½œæŒ‰é’® -->
      {% if product.is_available() %}
      <div class="flex gap-3">
        <a href="{{ url_for('main.product_detail', product_id=product.id) }}" 
           class="flex-1 text-center py-3 px-4 border-2 border-pink-200 text-pink-600 font-medium rounded-xl hover:bg-pink-50 transition-all duration-300">
          æŸ¥çœ‹è¯¦æƒ…
        </a>
        <button onclick="addToCart({{ product.id }})" 
                class="flex-1 btn-primary text-center py-3 px-4 font-medium rounded-xl">
          åŠ å…¥è´­ç‰©è½¦
        </button>
      </div>
      {% else %}
      <div class="bg-gray-100 text-gray-500 py-3 px-4 rounded-xl text-center font-medium">
        å•†å“å·²å”®å‡º
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="card text-center py-16">
  <div class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
    <span class="text-gray-400 text-3xl">ğŸ”</span>
  </div>
  <h3 class="text-2xl font-semibold text-gray-700 mb-4">æš‚æ— å•†å“</h3>
  <p class="text-gray-500 text-lg mb-6">
    {% if search_term %}
    æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "{{ search_term }}" çš„å•†å“ï¼Œè¯·å°è¯•å…¶ä»–æœç´¢è¯
    {% elif current_category %}
    è¯¥åˆ†ç±»ä¸‹æš‚æ— å•†å“
    {% else %}
    æš‚æ— å¯å”®å•†å“
    {% endif %}
  </p>
  {% if search_term or current_category %}
  <a href="{{ url_for('main.products') }}" class="btn-secondary">
    æŸ¥çœ‹å…¨éƒ¨å•†å“
  </a>
  {% endif %}
</div>
{% endif %}

<!-- JavaScript -->
<script>
// Advanced Filters Toggle
document.getElementById('toggleFilters').addEventListener('click', function() {
  const filters = document.getElementById('advancedFilters');
  const isHidden = filters.classList.contains('hidden');
  
  if (isHidden) {
    filters.classList.remove('hidden');
    this.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
      </svg>
      æ”¶èµ·ç­›é€‰
    `;
  } else {
    filters.classList.add('hidden');
    this.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
      </svg>
      ç­›é€‰
    `;
  }
});

// Auto-submit filters when changed
document.querySelectorAll('#advancedFilters select, #advancedFilters input').forEach(function(element) {
  element.addEventListener('change', function() {
    document.getElementById('searchForm').submit();
  });
});

// Quick search on Enter
document.getElementById('searchInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('searchForm').submit();
  }
});

// æœç´¢å»ºè®®åŠŸèƒ½
let searchTimeout;
const searchInput = document.getElementById('searchInput');
const searchSuggestions = document.getElementById('searchSuggestions');
let selectedSuggestionIndex = -1;

// æœç´¢å†å²è®°å½•
function getSearchHistory() {
  return JSON.parse(localStorage.getItem('searchHistory') || '[]');
}

function addToSearchHistory(query) {
  if (!query.trim()) return;
  
  let history = getSearchHistory();
  // ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒæŸ¥è¯¢
  history = history.filter(item => item !== query);
  // æ·»åŠ åˆ°å¼€å¤´
  history.unshift(query);
  // é™åˆ¶å†å²è®°å½•æ•°é‡
  history = history.slice(0, 10);
  
  localStorage.setItem('searchHistory', JSON.stringify(history));
}

// è·å–æœç´¢å»ºè®®
async function fetchSearchSuggestions(query) {
  if (query.length < 2) {
    showSearchHistory();
    return;
  }
  
  try {
    const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
    const suggestions = await response.json();
    showSearchSuggestions(suggestions);
  } catch (error) {
    console.error('è·å–æœç´¢å»ºè®®å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºæœç´¢å»ºè®®
function showSearchSuggestions(suggestions) {
  if (suggestions.length === 0) {
    hideSuggestions();
    return;
  }
  
  const getIconAndColor = (type) => {
    switch(type) {
      case 'product':
        return { icon: 'ğŸ“¦', bg: 'bg-blue-100', text: 'text-blue-600', label: 'å•†å“' };
      case 'category':
        return { icon: 'ğŸ·ï¸', bg: 'bg-green-100', text: 'text-green-600', label: 'åˆ†ç±»' };
      case 'price_range':
        return { icon: 'ğŸ’°', bg: 'bg-yellow-100', text: 'text-yellow-600', label: 'ä»·æ ¼' };
      case 'condition':
        return { icon: 'â­', bg: 'bg-purple-100', text: 'text-purple-600', label: 'æˆè‰²' };
      default:
        return { icon: 'ğŸ”', bg: 'bg-gray-100', text: 'text-gray-600', label: 'æœç´¢' };
    }
  };
  
  const html = suggestions.map((suggestion, index) => {
    const { icon, bg, text, label } = getIconAndColor(suggestion.type);
    
    const clickAction = suggestion.filter ? 
      `applyFilter('${suggestion.filter}')` : 
      `selectSuggestion('${suggestion.text.replace(/'/g, "\\'")}')`;
    
    return `
      <div class="suggestion-item px-4 py-3 hover:bg-pink-50 cursor-pointer flex items-center gap-3 ${index === selectedSuggestionIndex ? 'bg-pink-50' : ''} border-b border-gray-100 last:border-b-0"
           onclick="${clickAction}">
        <div class="w-8 h-8 rounded-full flex items-center justify-center ${bg}">
          <span class="${text} text-sm">${icon}</span>
        </div>
        <div class="flex-1">
          <div class="font-medium text-gray-800">${suggestion.text}</div>
          <div class="flex gap-2 text-xs text-gray-500">
            ${suggestion.category ? `<span>${suggestion.category}</span>` : ''}
            ${suggestion.price ? `<span>${suggestion.price}</span>` : ''}
            ${suggestion.condition ? `<span>${suggestion.condition}</span>` : ''}
            ${suggestion.count ? `<span>${suggestion.count}ä¸ªå•†å“</span>` : ''}
          </div>
        </div>
        <div class="text-xs text-gray-400">
          ${label}
        </div>
      </div>
    `;
  }).join('');
  
  searchSuggestions.innerHTML = html;
  searchSuggestions.classList.remove('hidden');
}

// åº”ç”¨è¿‡æ»¤å™¨å»ºè®®
function applyFilter(filterString) {
  const currentUrl = new URL(window.location.href);
  const params = new URLSearchParams(currentUrl.search);
  
  // è§£æè¿‡æ»¤å™¨å­—ç¬¦ä¸²
  const filterPairs = filterString.split('&');
  filterPairs.forEach(pair => {
    const [key, value] = pair.split('=');
    params.set(key, decodeURIComponent(value));
  });
  
  // é‡å®šå‘åˆ°æ–°çš„URL
  window.location.href = `/products?${params.toString()}`;
  hideSuggestions();
}

// æ˜¾ç¤ºæœç´¢å†å²
function showSearchHistory() {
  const history = getSearchHistory();
  if (history.length === 0) {
    hideSuggestions();
    return;
  }
  
  const html = `
    <div class="px-4 py-3 text-sm font-medium text-gray-700 border-b border-gray-200 bg-gray-50">
      <div class="flex items-center gap-2">
        <span class="text-gray-500">ğŸ•’</span>
        æœç´¢å†å²
      </div>
    </div>
    ${history.map((query, index) => `
      <div class="suggestion-item px-4 py-3 hover:bg-pink-50 cursor-pointer flex items-center gap-3 ${index === selectedSuggestionIndex ? 'bg-pink-50' : ''} border-b border-gray-100 last:border-b-0"
           onclick="selectSuggestion('${query.replace(/'/g, "\\'")}')">
        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
          <span class="text-gray-500 text-sm">ğŸ•’</span>
        </div>
        <div class="flex-1">
          <div class="font-medium text-gray-800">${query}</div>
        </div>
        <div class="text-xs text-gray-400">å†å²</div>
      </div>
    `).join('')}
  `;
  
  searchSuggestions.innerHTML = html;
  searchSuggestions.classList.remove('hidden');
}

// éšè—æœç´¢å»ºè®®
function hideSuggestions() {
  searchSuggestions.classList.add('hidden');
  selectedSuggestionIndex = -1;
}

// é€‰æ‹©å»ºè®®
function selectSuggestion(text) {
  searchInput.value = text;
  hideSuggestions();
  addToSearchHistory(text);
  searchInput.form.submit();
}

// æœç´¢è¾“å…¥äº‹ä»¶
searchInput.addEventListener('input', function() {
  clearTimeout(searchTimeout);
  const query = this.value.trim();
  
  if (query.length === 0) {
    showSearchHistory();
    return;
  }
  
  searchTimeout = setTimeout(() => {
    fetchSearchSuggestions(query);
  }, 300);
});

// æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºå»ºè®®
searchInput.addEventListener('focus', function() {
  const query = this.value.trim();
  if (query.length >= 2) {
    fetchSearchSuggestions(query);
  } else {
    showSearchHistory();
  }
});

// é”®ç›˜å¯¼èˆª
searchInput.addEventListener('keydown', function(e) {
  const suggestions = document.querySelectorAll('.suggestion-item');
  
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
    updateSelectedSuggestion();
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
    updateSelectedSuggestion();
  } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
    e.preventDefault();
    const selectedText = suggestions[selectedSuggestionIndex].querySelector('span').textContent;
    selectSuggestion(selectedText);
  } else if (e.key === 'Escape') {
    hideSuggestions();
  }
});

// æ›´æ–°é€‰ä¸­çš„å»ºè®®æ ·å¼
function updateSelectedSuggestion() {
  const suggestions = document.querySelectorAll('.suggestion-item');
  suggestions.forEach((item, index) => {
    if (index === selectedSuggestionIndex) {
      item.classList.add('bg-pink-50');
    } else {
      item.classList.remove('bg-pink-50');
    }
  });
}

// ç‚¹å‡»å¤–éƒ¨éšè—å»ºè®®
document.addEventListener('click', function(e) {
  if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
    hideSuggestions();
  }
});

// è¡¨å•æäº¤æ—¶ä¿å­˜æœç´¢å†å²
searchInput.form.addEventListener('submit', function() {
  const query = searchInput.value.trim();
  if (query) {
    addToSearchHistory(query);
  }
});

// æ·»åŠ åˆ°è´­ç‰©è½¦åŠŸèƒ½
function addToCart(productId) {
  // è·å–ç°æœ‰è´­ç‰©è½¦æ•°æ®
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  
  // æ£€æŸ¥å•†å“æ˜¯å¦å·²åœ¨è´­ç‰©è½¦ä¸­
  let existingItem = cart.find(item => item.id === productId);
  
  if (existingItem) {
    existingItem.quantity += 1;
    localStorage.setItem('cart', JSON.stringify(cart));
    showMessage('å•†å“æ•°é‡å·²æ›´æ–°ï¼', 'success');
    updateCartCount();
  } else {
    // è°ƒç”¨APIè·å–å•†å“ä¿¡æ¯å¹¶æ·»åŠ åˆ°è´­ç‰©è½¦
    fetch('/api/cart', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        product_id: productId,
        quantity: 1
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        cart.push({
          id: data.product.id,
          name: data.product.name,
          price: data.product.price,
          image: data.product.image,
          condition: data.product.condition,
          quantity: data.quantity
        });
        
        localStorage.setItem('cart', JSON.stringify(cart));
        showMessage('å•†å“å·²åŠ å…¥è´­ç‰©è½¦ï¼', 'success');
        updateCartCount();
      } else {
        showMessage(data.message || 'æ·»åŠ å¤±è´¥', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    });
  }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type = 'info') {
  const messageDiv = document.createElement('div');
  messageDiv.className = `fixed top-8 right-8 z-50 p-4 rounded-2xl shadow-2xl border transition-all duration-300 backdrop-blur-md ${
    type === 'success' ? 'bg-green-500/90 text-white border-green-400' : 
    type === 'error' ? 'bg-red-500/90 text-white border-red-400' : 
    'bg-blue-500/90 text-white border-blue-400'
  }`;
  messageDiv.style.transform = 'translateX(100%)';
  messageDiv.textContent = message;
  
  document.body.appendChild(messageDiv);
  
  // æ·»åŠ å…¥åœºåŠ¨ç”»
  setTimeout(() => {
    messageDiv.style.transform = 'translateX(0)';
  }, 100);
  
  // æ·»åŠ é€€åœºåŠ¨ç”»å’Œç§»é™¤
  setTimeout(() => {
    messageDiv.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (document.body.contains(messageDiv)) {
        document.body.removeChild(messageDiv);
      }
    }, 300);
  }, 3000);
}

// æ›´æ–°è´­ç‰©è½¦è®¡æ•°
function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  
  const cartCountElements = document.querySelectorAll('.cart-count');
  cartCountElements.forEach(element => {
    element.textContent = totalItems;
    element.style.display = totalItems > 0 ? 'inline' : 'none';
  });
}

// é¡µé¢åŠ è½½æ—¶æ›´æ–°è´­ç‰©è½¦è®¡æ•°
document.addEventListener('DOMContentLoaded', function() {
  updateCartCount();
});
</script>

{% endblock %}