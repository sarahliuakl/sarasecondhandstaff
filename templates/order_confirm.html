{% extends "base.html" %}
{% block title %}è®¢å•ç¡®è®¤ - Saraçš„äºŒæ‰‹å”®å–{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto">
  <h2 class="text-3xl font-bold text-orange-700 mb-6">è®¢å•ç¡®è®¤</h2>
  
  <!-- è®¢å•å•†å“åˆ—è¡¨ -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h3 class="text-xl font-semibold mb-4">è®¢å•å•†å“</h3>
    <div id="orderItems" class="space-y-4">
      <!-- å•†å“é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
    </div>
    
    <!-- è®¢å•æ€»è®¡ -->
    <div id="orderSummary" class="mt-6 pt-6 border-t border-gray-200">
      <div class="flex justify-between items-center mb-2">
        <span class="text-lg">å•†å“å°è®¡:</span>
        <span id="subtotal" class="text-lg font-semibold">NZD $0.00</span>
      </div>
      <div class="flex justify-between items-center mb-2">
        <span class="text-lg">é‚®è´¹:</span>
        <span id="shippingFee" class="text-lg font-semibold">å¾…é€‰æ‹©äº¤ä»˜æ–¹å¼</span>
      </div>
      <div class="flex justify-between items-center pt-2 border-t border-gray-200">
        <span class="text-xl font-bold">æ€»è®¡:</span>
        <span id="total" class="text-xl font-bold text-orange-600">NZD $0.00</span>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ·ä¿¡æ¯è¡¨å• -->
  <div class="bg-white rounded-lg shadow p-6">
    <h3 class="text-xl font-semibold mb-4">å®¢æˆ·ä¿¡æ¯</h3>
    
    <form id="orderForm" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <input type="hidden" id="cartData" name="cart_data" value="">
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="space-y-4">
          <div>
            <label class="block mb-1 font-semibold text-gray-700" for="customer_name">
              å§“å <span class="text-red-500">*</span>
            </label>
            <input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-orange-500" 
                   type="text" id="customer_name" name="customer_name" required>
          </div>
          
          <div>
            <label class="block mb-1 font-semibold text-gray-700" for="customer_email">
              é‚®ç®± <span class="text-red-500">*</span>
            </label>
            <input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-orange-500" 
                   type="email" id="customer_email" name="customer_email" 
                   placeholder="example@email.com" required>
            <p class="text-sm text-gray-500 mt-1">ç”¨äºè®¢å•ç¡®è®¤å’Œç‰©æµé€šçŸ¥</p>
          </div>
          
          <div>
            <label class="block mb-1 font-semibold text-gray-700" for="customer_phone">
              ç”µè¯ (å¯é€‰)
            </label>
            <input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-orange-500" 
                   type="tel" id="customer_phone" name="customer_phone" 
                   placeholder="021234567">
          </div>
        </div>

        <!-- äº¤ä»˜å’Œæ”¯ä»˜æ–¹å¼ -->
        <div class="space-y-4">
          <div>
            <label class="block mb-3 font-semibold text-gray-700">
              äº¤ä»˜æ–¹å¼ <span class="text-red-500">*</span>
            </label>
            <div id="deliveryOptions" class="space-y-2">
              <!-- äº¤ä»˜é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          
          <div>
            <label class="block mb-3 font-semibold text-gray-700">
              æ”¯ä»˜æ–¹å¼ <span class="text-red-500">*</span>
            </label>
            <div id="paymentOptions" class="space-y-2">
              <!-- æ”¯ä»˜é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ›´æ–° -->
            </div>
          </div>
        </div>
      </div>

      <!-- åœ°å€ä¿¡æ¯ (é‚®å¯„æ—¶æ˜¾ç¤º) -->
      <div id="addressSection" class="mt-6 hidden">
        <label class="block mb-1 font-semibold text-gray-700" for="customer_address">
          è¯¦ç»†åœ°å€ <span class="text-red-500">*</span>
        </label>
        <textarea class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-orange-500" 
                  id="customer_address" name="customer_address" rows="3" 
                  placeholder="è¯·å¡«å†™å®Œæ•´çš„é‚®å¯„åœ°å€ï¼ŒåŒ…æ‹¬é—¨ç‰Œå·ã€è¡—é“ã€åŸå¸‚ã€é‚®ç¼–"></textarea>
      </div>

      <!-- å¤‡æ³¨ -->
      <div class="mt-6">
        <label class="block mb-1 font-semibold text-gray-700" for="notes">
          å¤‡æ³¨ (å¯é€‰)
        </label>
        <textarea class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-orange-500" 
                  id="notes" name="notes" rows="3" 
                  placeholder="æœ‰å…¶ä»–è¦æ±‚æˆ–é—®é¢˜å¯ä»¥åœ¨è¿™é‡Œè¯´æ˜"></textarea>
      </div>

      <!-- æäº¤æŒ‰é’® -->
      <div class="mt-8 flex flex-col sm:flex-row gap-4">
        <button type="submit" 
                class="flex-1 bg-orange-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-orange-600 transition">
          æäº¤è®¢å•
        </button>
        <a href="{{ url_for('cart') }}" 
           class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg font-semibold text-center hover:bg-gray-200 transition">
          è¿”å›è´­ç‰©è½¦
        </a>
      </div>
    </form>
  </div>

  <!-- è®¢å•é¡»çŸ¥ -->
  <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
    <h3 class="text-lg font-semibold text-blue-800 mb-3">è®¢å•é¡»çŸ¥</h3>
    <ul class="text-sm text-blue-700 space-y-1">
      <li>â€¢ æäº¤è®¢å•åï¼Œæˆ‘ä¼šåœ¨2å°æ—¶å†…é€šè¿‡é‚®ç®±è”ç³»æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…</li>
      <li>â€¢ è¯·ç¡®ä¿é‚®ç®±åœ°å€æ­£ç¡®ï¼Œä»¥ä¾¿åŠæ—¶æ”¶åˆ°è®¢å•ç¡®è®¤å’Œç‰©æµä¿¡æ¯</li>
      <li>â€¢ å½“é¢äº¤æ˜“åœ°ç‚¹ä¼šé€šè¿‡é‚®ä»¶/çŸ­ä¿¡ç¡®è®¤ï¼Œä¿æŠ¤åŒæ–¹éšç§</li>
      <li>â€¢ é“¶è¡Œè½¬è´¦è¯·åœ¨ç¡®è®¤è®¢å•åè¿›è¡Œï¼Œè½¬è´¦åè¯·å‘ŠçŸ¥ä»¥ä¾¿åŠæ—¶å‘è´§</li>
      <li>â€¢ äºŒæ‰‹ç‰©å“ç»å½“é¢ç¡®è®¤åä¸æ”¯æŒé€€è´§ï¼Œè¯·è°¨æ…é€‰æ‹©</li>
      <li>â€¢ å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»ï¼š0225255862</li>
    </ul>
  </div>
</div>

<!-- æ˜¾ç¤ºFlashæ¶ˆæ¯ -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="fixed top-4 right-4 z-50 space-y-2">
      {% for category, message in messages %}
        <div class="p-4 rounded-lg shadow-lg {{ 'bg-green-500 text-white' if category == 'success' else 'bg-red-500 text-white' if category == 'error' else 'bg-blue-500 text-white' }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    
    <script>
      // 3ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
      setTimeout(function() {
        const messages = document.querySelectorAll('.fixed.top-4.right-4 > div');
        messages.forEach(msg => msg.remove());
      }, 3000);
    </script>
  {% endif %}
{% endwith %}

<script>
// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè®¢å•å†…å®¹
document.addEventListener('DOMContentLoaded', function() {
  displayOrderItems();
  
  // å¦‚æœè´­ç‰©è½¦ä¸ºç©ºï¼Œé‡å®šå‘å›è´­ç‰©è½¦é¡µé¢
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (cart.length === 0) {
    window.location.href = '{{ url_for("cart") }}';
    return;
  }
  
  // åˆå§‹åŒ–äº¤ä»˜å’Œæ”¯ä»˜é€‰é¡¹
  initializeDeliveryOptions();
  initializePaymentOptions();
});

// åˆå§‹åŒ–äº¤ä»˜é€‰é¡¹
function initializeDeliveryOptions() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const deliveryOptions = document.getElementById('deliveryOptions');
  let hasFaceToFaceOnlyItems = false;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ä»…è§é¢äº¤æ˜“å•†å“
  cart.forEach(item => {
    if (item.face_to_face_only) {
      hasFaceToFaceOnlyItems = true;
    }
  });
  
  if (hasFaceToFaceOnlyItems) {
    // å¦‚æœæœ‰ä»…è§é¢äº¤æ˜“å•†å“ï¼Œåªæ˜¾ç¤ºå½“é¢äº¤æ˜“é€‰é¡¹
    deliveryOptions.innerHTML = `
      <label class="flex items-center">
        <input type="radio" name="delivery_method" value="pickup" class="mr-2" onchange="updateShipping()" required checked>
        <span class="text-gray-700">å½“é¢äº¤æ˜“ (å¥¥å…‹å…°åœ°åŒºï¼Œå…é‚®è´¹)</span>
      </label>
      <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded text-sm text-purple-700">
        <strong>æ³¨æ„ï¼š</strong>æ‚¨çš„è´­ç‰©è½¦ä¸­åŒ…å«ä»…è§é¢äº¤æ˜“å•†å“ï¼Œåªèƒ½é€‰æ‹©å½“é¢äº¤æ˜“æ–¹å¼
      </div>
    `;
  } else {
    // æ™®é€šå•†å“ï¼Œæ˜¾ç¤ºæ‰€æœ‰äº¤ä»˜é€‰é¡¹
    deliveryOptions.innerHTML = `
      <label class="flex items-center">
        <input type="radio" name="delivery_method" value="pickup" class="mr-2" onchange="updateShipping()" required>
        <span class="text-gray-700">å½“é¢äº¤æ˜“ (å¥¥å…‹å…°åœ°åŒºï¼Œå…é‚®è´¹)</span>
      </label>
      <label class="flex items-center">
        <input type="radio" name="delivery_method" value="shipping" class="mr-2" onchange="updateShipping()" required>
        <span class="text-gray-700">é‚®å¯„ (æ–°è¥¿å…°å…¨å›½ï¼Œé‚®è´¹ NZD $15)</span>
      </label>
    `;
  }
  
  // å¦‚æœæœ‰ä»…è§é¢äº¤æ˜“å•†å“ï¼Œè‡ªåŠ¨é€‰æ‹©å½“é¢äº¤æ˜“å¹¶æ›´æ–°æ€»è®¡
  if (hasFaceToFaceOnlyItems) {
    updateShipping();
  }
}

// åˆå§‹åŒ–æ”¯ä»˜é€‰é¡¹
function initializePaymentOptions() {
  const paymentOptions = document.getElementById('paymentOptions');
  // é»˜è®¤æ˜¾ç¤ºå½“é¢äº¤æ˜“çš„æ”¯ä»˜é€‰é¡¹
  paymentOptions.innerHTML = `
    <label class="flex items-center">
      <input type="radio" name="payment_method" value="anz_transfer" class="mr-2" required>
      <span class="text-gray-700">ANZé“¶è¡Œè½¬è´¦</span>
    </label>
    <label class="flex items-center">
      <input type="radio" name="payment_method" value="bank_transfer" class="mr-2" required>
      <span class="text-gray-700">è·¨è¡Œè½¬è´¦</span>
    </label>
    <label class="flex items-center">
      <input type="radio" name="payment_method" value="cash" class="mr-2" required>
      <span class="text-gray-700">ç°é‡‘æ”¯ä»˜ (å½“é¢äº¤æ˜“)</span>
    </label>
    <label class="flex items-center">
      <input type="radio" name="payment_method" value="wechat_alipay" class="mr-2" required>
      <span class="text-gray-700">å¾®ä¿¡/æ”¯ä»˜å® (å½“é¢äº¤æ˜“)</span>
    </label>
    <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-700">
      <strong>å½“é¢äº¤æ˜“è¯´æ˜ï¼š</strong>å¯ä»¥é€‰æ‹©ç°é‡‘æˆ–ç§»åŠ¨æ”¯ä»˜ï¼Œå®‰å…¨ä¾¿æ·
    </div>
  `;
}

// æ˜¾ç¤ºè®¢å•å•†å“
function displayOrderItems() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const orderItems = document.getElementById('orderItems');
  
  if (cart.length === 0) {
    orderItems.innerHTML = '<p class="text-gray-500">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>';
    return;
  }
  
  // æ¸…ç©ºç°æœ‰å†…å®¹
  orderItems.innerHTML = '';
  
  // æ·»åŠ å•†å“é¡¹
  cart.forEach(item => {
    const itemElement = createOrderItemElement(item);
    orderItems.appendChild(itemElement);
  });
  
  // æ›´æ–°è®¢å•æ€»è®¡
  updateOrderSummary();
  
  // è®¾ç½®è¡¨å•ä¸­çš„è´­ç‰©è½¦æ•°æ®
  document.getElementById('cartData').value = JSON.stringify(cart);
}

// åˆ›å»ºè®¢å•å•†å“å…ƒç´ 
function createOrderItemElement(item) {
  const div = document.createElement('div');
  div.className = 'flex items-center gap-4 py-4 border-b border-gray-100';
  
  div.innerHTML = `
    <div class="flex-shrink-0">
      <img src="${item.image || 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=400&q=80'}" 
           alt="${item.name}" 
           class="w-16 h-16 object-cover rounded">
    </div>
    
    <div class="flex-1">
      <h4 class="font-semibold">${item.name}</h4>
      <p class="text-sm text-gray-600">æˆè‰²ï¼š${item.condition}</p>
      <p class="text-sm text-gray-600">æ•°é‡ï¼š${item.quantity}</p>
      ${item.face_to_face_only ? '<p class="text-xs text-purple-600">ğŸ”’ ä»…è§é¢äº¤æ˜“</p>' : ''}
    </div>
    
    <div class="text-right">
      <p class="font-semibold text-orange-600">NZD $${(item.price * item.quantity).toFixed(2)}</p>
    </div>
  `;
  
  return div;
}

// æ›´æ–°è®¢å•æ€»è®¡
function updateOrderSummary() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  let subtotal = 0;
  
  cart.forEach(item => {
    subtotal += item.price * item.quantity;
  });
  
  // è·å–é€‰ä¸­çš„äº¤ä»˜æ–¹å¼
  const deliveryMethodInputs = document.querySelectorAll('input[name="delivery_method"]');
  let shippingFee = 0;
  let shippingText = 'å¾…é€‰æ‹©äº¤ä»˜æ–¹å¼';
  
  for (const input of deliveryMethodInputs) {
    if (input.checked) {
      if (input.value === 'shipping') {
        shippingFee = 15.00;
        shippingText = 'NZD $15.00';
      } else {
        shippingFee = 0;
        shippingText = 'å…è´¹';
      }
      break;
    }
  }
  
  const total = subtotal + shippingFee;
  
  document.getElementById('subtotal').textContent = `NZD $${subtotal.toFixed(2)}`;
  document.getElementById('shippingFee').textContent = shippingText;
  document.getElementById('total').textContent = `NZD $${total.toFixed(2)}`;
}

// æ›´æ–°é‚®è´¹æ˜¾ç¤ºå’Œæ”¯ä»˜é€‰é¡¹
function updateShipping() {
  const deliveryMethod = document.querySelector('input[name="delivery_method"]:checked').value;
  const addressSection = document.getElementById('addressSection');
  const paymentOptions = document.getElementById('paymentOptions');
  
  // æ˜¾ç¤º/éšè—åœ°å€è¾“å…¥æ¡†
  if (deliveryMethod === 'shipping') {
    addressSection.classList.remove('hidden');
    document.getElementById('customer_address').required = true;
    
    // é‚®å¯„æ—¶çš„æ”¯ä»˜é€‰é¡¹ï¼šåªæœ‰è½¬è´¦å’Œç§»åŠ¨æ”¯ä»˜
    paymentOptions.innerHTML = `
      <label class="flex items-center">
        <input type="radio" name="payment_method" value="anz_transfer" class="mr-2" required>
        <span class="text-gray-700">ANZé“¶è¡Œè½¬è´¦ (æ¨è)</span>
      </label>
      <label class="flex items-center">
        <input type="radio" name="payment_method" value="bank_transfer" class="mr-2" required>
        <span class="text-gray-700">è·¨è¡Œè½¬è´¦</span>
      </label>
      <label class="flex items-center">
        <input type="radio" name="payment_method" value="wechat_alipay" class="mr-2" required>
        <span class="text-gray-700">å¾®ä¿¡/æ”¯ä»˜å®è½¬è´¦</span>
      </label>
      <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700">
        <strong>é‚®å¯„è¯´æ˜ï¼š</strong>éœ€è¦å…ˆä»˜æ¬¾ç¡®è®¤åæ‰ä¼šå®‰æ’é‚®å¯„ï¼Œè¯·é€‰æ‹©åˆé€‚çš„è½¬è´¦æ–¹å¼
      </div>
    `;
  } else {
    addressSection.classList.add('hidden');
    document.getElementById('customer_address').required = false;
    
    // å½“é¢äº¤æ˜“æ—¶çš„æ”¯ä»˜é€‰é¡¹ï¼šåŒ…æ‹¬ç°é‡‘
    paymentOptions.innerHTML = `
      <label class="flex items-center">
        <input type="radio" name="payment_method" value="anz_transfer" class="mr-2" required>
        <span class="text-gray-700">ANZé“¶è¡Œè½¬è´¦</span>
      </label>
      <label class="flex items-center">
        <input type="radio" name="payment_method" value="bank_transfer" class="mr-2" required>
        <span class="text-gray-700">è·¨è¡Œè½¬è´¦</span>
      </label>
      <label class="flex items-center">
        <input type="radio" name="payment_method" value="cash" class="mr-2" required>
        <span class="text-gray-700">ç°é‡‘æ”¯ä»˜ (å½“é¢äº¤æ˜“)</span>
      </label>
      <label class="flex items-center">
        <input type="radio" name="payment_method" value="wechat_alipay" class="mr-2" required>
        <span class="text-gray-700">å¾®ä¿¡/æ”¯ä»˜å® (å½“é¢äº¤æ˜“)</span>
      </label>
      <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-700">
        <strong>å½“é¢äº¤æ˜“è¯´æ˜ï¼š</strong>å¯ä»¥é€‰æ‹©ç°é‡‘æˆ–ç§»åŠ¨æ”¯ä»˜ï¼Œå®‰å…¨ä¾¿æ·
      </div>
    `;
  }
  
  // æ›´æ–°æ€»è®¡
  updateOrderSummary();
}

// è¡¨å•æäº¤å‰éªŒè¯
document.getElementById('orderForm').addEventListener('submit', function(e) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (cart.length === 0) {
    e.preventDefault();
    alert('è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œæ— æ³•æäº¤è®¢å•');
    return;
  }
  
  // éªŒè¯é‚®ç®±æ ¼å¼
  const email = document.getElementById('customer_email').value;
  const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  if (!emailPattern.test(email)) {
    e.preventDefault();
    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
    return;
  }
  
  // å¦‚æœé€‰æ‹©é‚®å¯„ï¼ŒéªŒè¯åœ°å€
  const deliveryMethod = document.querySelector('input[name="delivery_method"]:checked');
  if (deliveryMethod && deliveryMethod.value === 'shipping') {
    const address = document.getElementById('customer_address').value.trim();
    if (!address) {
      e.preventDefault();
      alert('é€‰æ‹©é‚®å¯„æ—¶å¿…é¡»å¡«å†™è¯¦ç»†åœ°å€');
      return;
    }
  }
  
  // æ›´æ–°è´­ç‰©è½¦æ•°æ®åˆ°è¡¨å•
  document.getElementById('cartData').value = JSON.stringify(cart);
});
</script>

{% endblock %}